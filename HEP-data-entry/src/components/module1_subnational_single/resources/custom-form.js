var module1SubnationalId = "Humg4HbkmJg";

var calculatedNumericCells = [
    //Working Details

    //1 - Medical Doctors
    {
        id: "qcDKkL7Xkl4-Xr12mI7VPn3-val",
        children: [
            "mHFT8rZ6ksz-Xr12mI7VPn3-val",
            "qMdjQN91JDi-Xr12mI7VPn3-val",
            "ePgUyGHxJuI-Xr12mI7VPn3-val",
        ],
    },
    //2 - Nursing Personnel
    {
        id: "ok6yvzSABcU-Xr12mI7VPn3-val",
        children: [
            "Rnuo4SphAdV-Xr12mI7VPn3-val",
            "mHD3Efts57E-Xr12mI7VPn3-val",
            "T58TEnz6WgZ-Xr12mI7VPn3-val",
        ],
    },
    //3 - Midwifery personnel
    {
        id: "bDQt7HaZCu9-Xr12mI7VPn3-val",
        children: [
            "EqDGfdOIX9a-Xr12mI7VPn3-val",
            "rfqaKzMPEdf-Xr12mI7VPn3-val",
            "QC2yRZy5Fn7-Xr12mI7VPn3-val",
        ],
    },
];

var calculatedCheckboxCells = [
    //Working Details
    //1 - Medical Doctors
    {
        id: "TVBVT6naFjQ-bj9TvyIDtwi-val",
        children: [
            "t8Oxv1y44wM-bj9TvyIDtwi-val",
            "BhkUnrfLZ1F-bj9TvyIDtwi-val",
            "y8MA1BOZ3OO-bj9TvyIDtwi-val",
        ],
    },
    {
        id: "TVBVT6naFjQ-lcB0UtS4nuB-val",
        children: [
            "t8Oxv1y44wM-lcB0UtS4nuB-val",
            "BhkUnrfLZ1F-lcB0UtS4nuB-val",
            "y8MA1BOZ3OO-lcB0UtS4nuB-val",
        ],
    },
    {
        id: "TVBVT6naFjQ-LvGn3KFEzvA-val",
        children: [
            "t8Oxv1y44wM-LvGn3KFEzvA-val",
            "BhkUnrfLZ1F-LvGn3KFEzvA-val",
            "y8MA1BOZ3OO-LvGn3KFEzvA-val",
        ],
    },
    {
        id: "TVBVT6naFjQ-wcnRf5LJrnK-val",
        children: [
            "t8Oxv1y44wM-wcnRf5LJrnK-val",
            "BhkUnrfLZ1F-wcnRf5LJrnK-val",
            "y8MA1BOZ3OO-wcnRf5LJrnK-val",
        ],
    },
    {
        id: "TVBVT6naFjQ-MXfWGD11wLh-val",
        children: [
            "t8Oxv1y44wM-MXfWGD11wLh-val",
            "BhkUnrfLZ1F-MXfWGD11wLh-val",
            "y8MA1BOZ3OO-MXfWGD11wLh-val",
        ],
    },
    {
        id: "TVBVT6naFjQ-P5jMO9Y0SRn-val",
        children: [
            "t8Oxv1y44wM-P5jMO9Y0SRn-val",
            "BhkUnrfLZ1F-P5jMO9Y0SRn-val",
            "y8MA1BOZ3OO-P5jMO9Y0SRn-val",
        ],
    },
    {
        id: "TVBVT6naFjQ-eWjpUQpzWKX-val",
        children: [
            "t8Oxv1y44wM-eWjpUQpzWKX-val",
            "BhkUnrfLZ1F-eWjpUQpzWKX-val",
            "y8MA1BOZ3OO-eWjpUQpzWKX-val",
        ],
    },
    {
        id: "TVBVT6naFjQ-hC2N9T8F5JD-val",
        children: [
            "t8Oxv1y44wM-hC2N9T8F5JD-val",
            "BhkUnrfLZ1F-hC2N9T8F5JD-val",
            "y8MA1BOZ3OO-hC2N9T8F5JD-val",
        ],
    },
    {
        id: "TVBVT6naFjQ-xgbBSeyiDWp-val",
        children: [
            "t8Oxv1y44wM-xgbBSeyiDWp-val",
            "BhkUnrfLZ1F-xgbBSeyiDWp-val",
            "y8MA1BOZ3OO-xgbBSeyiDWp-val",
        ],
    },
    {
        id: "TVBVT6naFjQ-IhnQTXo2sCi-val",
        children: [
            "t8Oxv1y44wM-IhnQTXo2sCi-val",
            "BhkUnrfLZ1F-IhnQTXo2sCi-val",
            "y8MA1BOZ3OO-IhnQTXo2sCi-val",
        ],
    },
    {
        id: "TVBVT6naFjQ-rEUC186wftQ-val",
        children: [
            "t8Oxv1y44wM-rEUC186wftQ-val",
            "BhkUnrfLZ1F-rEUC186wftQ-val",
            "y8MA1BOZ3OO-rEUC186wftQ-val",
        ],
    },
    {
        id: "TVBVT6naFjQ-s5mo8EjeKiY-val",
        children: [
            "t8Oxv1y44wM-s5mo8EjeKiY-val",
            "BhkUnrfLZ1F-s5mo8EjeKiY-val",
            "y8MA1BOZ3OO-s5mo8EjeKiY-val",
        ],
    },
    {
        id: "TVBVT6naFjQ-ADfCJWnnU2O-val",
        children: [
            "t8Oxv1y44wM-ADfCJWnnU2O-val",
            "BhkUnrfLZ1F-ADfCJWnnU2O-val",
            "y8MA1BOZ3OO-ADfCJWnnU2O-val",
        ],
    },
    //2 - Nursing Personnel
    {
        id: "SV71PdZSkmd-bj9TvyIDtwi-val",
        children: [
            "TdwikGCtQ2F-bj9TvyIDtwi-val",
            "WGJxTIBFQK2-bj9TvyIDtwi-val",
            "OgG8wQ6Zajq-bj9TvyIDtwi-val",
        ],
    },
    {
        id: "SV71PdZSkmd-lcB0UtS4nuB-val",
        children: [
            "TdwikGCtQ2F-lcB0UtS4nuB-val",
            "WGJxTIBFQK2-lcB0UtS4nuB-val",
            "OgG8wQ6Zajq-lcB0UtS4nuB-val",
        ],
    },
    {
        id: "SV71PdZSkmd-LvGn3KFEzvA-val",
        children: [
            "TdwikGCtQ2F-LvGn3KFEzvA-val",
            "WGJxTIBFQK2-LvGn3KFEzvA-val",
            "OgG8wQ6Zajq-LvGn3KFEzvA-val",
        ],
    },
    {
        id: "SV71PdZSkmd-wcnRf5LJrnK-val",
        children: [
            "TdwikGCtQ2F-wcnRf5LJrnK-val",
            "WGJxTIBFQK2-wcnRf5LJrnK-val",
            "OgG8wQ6Zajq-wcnRf5LJrnK-val",
        ],
    },
    {
        id: "SV71PdZSkmd-MXfWGD11wLh-val",
        children: [
            "TdwikGCtQ2F-MXfWGD11wLh-val",
            "WGJxTIBFQK2-MXfWGD11wLh-val",
            "OgG8wQ6Zajq-MXfWGD11wLh-val",
        ],
    },
    {
        id: "SV71PdZSkmd-P5jMO9Y0SRn-val",
        children: [
            "TdwikGCtQ2F-P5jMO9Y0SRn-val",
            "WGJxTIBFQK2-P5jMO9Y0SRn-val",
            "OgG8wQ6Zajq-P5jMO9Y0SRn-val",
        ],
    },
    {
        id: "SV71PdZSkmd-eWjpUQpzWKX-val",
        children: [
            "TdwikGCtQ2F-eWjpUQpzWKX-val",
            "WGJxTIBFQK2-eWjpUQpzWKX-val",
            "OgG8wQ6Zajq-eWjpUQpzWKX-val",
        ],
    },
    {
        id: "SV71PdZSkmd-hC2N9T8F5JD-val",
        children: [
            "TdwikGCtQ2F-hC2N9T8F5JD-val",
            "WGJxTIBFQK2-hC2N9T8F5JD-val",
            "OgG8wQ6Zajq-hC2N9T8F5JD-val",
        ],
    },
    {
        id: "SV71PdZSkmd-xgbBSeyiDWp-val",
        children: [
            "TdwikGCtQ2F-xgbBSeyiDWp-val",
            "WGJxTIBFQK2-xgbBSeyiDWp-val",
            "OgG8wQ6Zajq-xgbBSeyiDWp-val",
        ],
    },
    {
        id: "SV71PdZSkmd-IhnQTXo2sCi-val",
        children: [
            "TdwikGCtQ2F-IhnQTXo2sCi-val",
            "WGJxTIBFQK2-IhnQTXo2sCi-val",
            "OgG8wQ6Zajq-IhnQTXo2sCi-val",
        ],
    },
    {
        id: "SV71PdZSkmd-rEUC186wftQ-val",
        children: [
            "TdwikGCtQ2F-rEUC186wftQ-val",
            "WGJxTIBFQK2-rEUC186wftQ-val",
            "OgG8wQ6Zajq-rEUC186wftQ-val",
        ],
    },
    {
        id: "SV71PdZSkmd-s5mo8EjeKiY-val",
        children: [
            "TdwikGCtQ2F-s5mo8EjeKiY-val",
            "WGJxTIBFQK2-s5mo8EjeKiY-val",
            "OgG8wQ6Zajq-s5mo8EjeKiY-val",
        ],
    },
    {
        id: "SV71PdZSkmd-ADfCJWnnU2O-val",
        children: [
            "TdwikGCtQ2F-ADfCJWnnU2O-val",
            "WGJxTIBFQK2-ADfCJWnnU2O-val",
            "OgG8wQ6Zajq-ADfCJWnnU2O-val",
        ],
    },
    //3 - Midwifery personnel
    {
        id: "V8OUvPiHabT-bj9TvyIDtwi-val",
        children: [
            "RSMht6Qosgc-bj9TvyIDtwi-val",
            "oLW42C1cyO6-bj9TvyIDtwi-val",
            "lJEqAtOXtsG-bj9TvyIDtwi-val",
        ],
    },
    {
        id: "V8OUvPiHabT-lcB0UtS4nuB-val",
        children: [
            "RSMht6Qosgc-lcB0UtS4nuB-val",
            "oLW42C1cyO6-lcB0UtS4nuB-val",
            "lJEqAtOXtsG-lcB0UtS4nuB-val",
        ],
    },
    {
        id: "V8OUvPiHabT-LvGn3KFEzvA-val",
        children: [
            "RSMht6Qosgc-LvGn3KFEzvA-val",
            "oLW42C1cyO6-LvGn3KFEzvA-val",
            "lJEqAtOXtsG-LvGn3KFEzvA-val",
        ],
    },
    {
        id: "V8OUvPiHabT-wcnRf5LJrnK-val",
        children: [
            "RSMht6Qosgc-wcnRf5LJrnK-val",
            "oLW42C1cyO6-wcnRf5LJrnK-val",
            "lJEqAtOXtsG-wcnRf5LJrnK-val",
        ],
    },
    {
        id: "V8OUvPiHabT-MXfWGD11wLh-val",
        children: [
            "RSMht6Qosgc-MXfWGD11wLh-val",
            "oLW42C1cyO6-MXfWGD11wLh-val",
            "lJEqAtOXtsG-MXfWGD11wLh-val",
        ],
    },
    {
        id: "V8OUvPiHabT-P5jMO9Y0SRn-val",
        children: [
            "RSMht6Qosgc-P5jMO9Y0SRn-val",
            "oLW42C1cyO6-P5jMO9Y0SRn-val",
            "lJEqAtOXtsG-P5jMO9Y0SRn-val",
        ],
    },
    {
        id: "V8OUvPiHabT-eWjpUQpzWKX-val",
        children: [
            "RSMht6Qosgc-eWjpUQpzWKX-val",
            "oLW42C1cyO6-eWjpUQpzWKX-val",
            "lJEqAtOXtsG-eWjpUQpzWKX-val",
        ],
    },
    {
        id: "V8OUvPiHabT-hC2N9T8F5JD-val",
        children: [
            "RSMht6Qosgc-hC2N9T8F5JD-val",
            "oLW42C1cyO6-hC2N9T8F5JD-val",
            "lJEqAtOXtsG-hC2N9T8F5JD-val",
        ],
    },
    {
        id: "V8OUvPiHabT-xgbBSeyiDWp-val",
        children: [
            "RSMht6Qosgc-IhnQTXo2sCi-val",
            "oLW42C1cyO6-xgbBSeyiDWp-val",
            "lJEqAtOXtsG-xgbBSeyiDWp-val",
        ],
    },
    {
        id: "V8OUvPiHabT-IhnQTXo2sCi-val",
        children: [
            "RSMht6Qosgc-xgbBSeyiDWp-val",
            "oLW42C1cyO6-IhnQTXo2sCi-val",
            "lJEqAtOXtsG-IhnQTXo2sCi-val",
        ],
    },
    {
        id: "V8OUvPiHabT-rEUC186wftQ-val",
        children: [
            "RSMht6Qosgc-rEUC186wftQ-val",
            "oLW42C1cyO6-rEUC186wftQ-val",
            "lJEqAtOXtsG-rEUC186wftQ-val",
        ],
    },
    {
        id: "V8OUvPiHabT-s5mo8EjeKiY-val",
        children: [
            "RSMht6Qosgc-s5mo8EjeKiY-val",
            "oLW42C1cyO6-s5mo8EjeKiY-val",
            "lJEqAtOXtsG-s5mo8EjeKiY-val",
        ],
    },
    {
        id: "V8OUvPiHabT-ADfCJWnnU2O-val",
        children: [
            "RSMht6Qosgc-ADfCJWnnU2O-val",
            "oLW42C1cyO6-ADfCJWnnU2O-val",
            "lJEqAtOXtsG-ADfCJWnnU2O-val",
        ],
    },
];

function calculateNumericCell(inputId) {
    const items = inputId.split("-");
    items.shift();
    const noOrgUnitId = items.join("-");
    const organisationUnitId = inputId.split("-")[0];
    var total = 0;

    var calculateNumericCell = calculatedNumericCells.find(cell => {
        return cell.id == noOrgUnitId;
    });

    calculateNumericCell.children.forEach(childId => {
        const ouChildId = organisationUnitId + "-" + childId;

        var value = $("#" + ouChildId).val();

        if (value != "" && !isNaN(value)) {
            total = total + parseInt(value);
        }
    });

    $("#" + inputId).val(total);
    $("#" + inputId).trigger("change");
}

function calculateCheckboxCell(inputId) {
    const items = inputId.split("-");
    items.shift();
    const noOrgUnitId = items.join("-");
    const organisationUnitId = inputId.split("-")[0];

    var isChecked = false;

    var calculateCheckboxCell = calculatedCheckboxCells.find(cell => {
        return cell.id == noOrgUnitId;
    });

    calculateCheckboxCell.children.forEach(childId => {
        const ouChildId = organisationUnitId + "-" + childId;
        var childIsChecked = $("#" + ouChildId).is(":checked");

        if (childIsChecked == true) {
            isChecked = true;
        }
    });

    $("#" + inputId).prop("checked", isChecked);
    $("#" + inputId).trigger("change");
}

function onInputChange(id) {
    const organisationUnitId = id.split("-")[0];
    const dataElementId = id.split("-")[1];
    const optionComboId = id.split("-")[2];

    saveVal(dataElementId, optionComboId, id);

    calculatedNumericCells.forEach(calculatedNumericCell => {
        calculatedNumericCell.children.forEach(function(childId) {
            if (id === organisationUnitId + "-" + childId) {
                calculateNumericCell(organisationUnitId + "-" + calculatedNumericCell.id);
                return;
            }
        });
    });
}

function onCheckboxInputChange(id) {
    const organisationUnitId = id.split("-")[0];
    const dataElementId = id.split("-")[1];
    const optionComboId = id.split("-")[2];

    dhis2.de.currentOrganisationUnitId = organisationUnitId;

    saveTrueOnly(dataElementId, optionComboId, id);

    calculatedCheckboxCells.forEach(calculatedCheckboxCell => {
        calculatedCheckboxCell.children.forEach(function(childId) {
            if (id === organisationUnitId + "-" + childId) {
                calculateCheckboxCell(organisationUnitId + "-" + calculatedCheckboxCell.id);
                return;
            }
        });
    });
}

function get_resource_link(element_id, tokens) {
    $.ajax({
        url: "../api/documents",
        type: "get",
        data: {
            fields: "id",
            filter: "name:token:" + tokens,
        },
        success: function(response) {
            id = response["documents"][0]["id"];
            document.getElementById(element_id).href = "../api/documents/" + id + "/data";
        },
        error: function(xhr) {
            console.log("Error in the request");
            console.log(xhr);
        },
    });
}

function showCheckboxes(element) {
    var checkboxes = document.getElementById(element);

    if (checkboxes.style.display === "none") {
        checkboxes.style.display = "block";
        expanded = true;
    } else {
        checkboxes.style.display = "none";
        expanded = false;
    }
}

function loadValues() {
    var periodId = $("#selectedPeriodId").val();

    var params = {
        period: periodId,
        dataSet: module1SubnationalId,
        orgUnit: dhis2.de.getCurrentOrganisationUnit(),
        children: true,
    };

    $.ajax({
        url: "../api/dataValueSets",
        data: params,
        dataType: "json",
        success: json => {
            $.safeEach(json.dataValues, function(i, dataValue) {
                var fieldId = `#${dataValue.orgUnit}-${dataValue.dataElement}-${dataValue.categoryOptionCombo}-val`;
                if ($(fieldId).length > 0) {
                    var entryField = $(fieldId);
                    if ("true" == dataValue.value && entryField.attr("type") == "checkbox") {
                        $(fieldId).prop("checked", true);
                    } else {
                        $(fieldId).val(dataValue.value);
                    }
                }
            });

            $("input[type=text]").on("change", function(e) {
                onInputChange(e.target.id);
            });
            $("textarea").on("change", function(e) {
                onInputChange(e.target.id);
            });
            $("input[type=checkbox]").on("change", function(e) {
                onCheckboxInputChange(e.target.id);
            });
        },
        error: function(xhr) {
            console.log("Error in the request");
            console.log(xhr);
        },
    });
}

function renderCustomForm() {
    $("#content").empty();
    $("#custom-form-loader").show();

    const filter = `var=dataSet:${module1SubnationalId}&var=orgUnit:${dhis2.de.currentOrganisationUnitId}`;

    $.ajax({
        url: `../api/sqlViews/F9WNm3XNjli/data?${filter}`,
        type: "get",
        success: function(response) {
            const orgUnits = response.listGrid.rows.map(row => ({
                orgUnitId: row[0],
                orgUnitName: row[1],
            }));

            const orgUnitTables = orgUnits.map(orgUnit => {
                var template = document.getElementById("template").innerHTML;
                return Mustache.render(template, orgUnit);
            });

            document.getElementById("content").innerHTML = orgUnitTables.join();

            $(".read-only input").each(function() {
                $(this).attr("disabled", "disabled");
            });

            $("#custom-form-loader").hide();

            loadValues();
        },
        error: function(xhr) {
            console.log("Error in the request");
            console.log(xhr);
        },
    });
}

$(document).ready(function() {
    $(function() {
        $("#mod2_tabs").tabs();

        dhis2.util.on("dhis2.de.event.dataValuesLoaded", function(event, ds) {
            renderCustomForm();
        });
    });
    $(function() {
        console.log("Updating file resources links");
        get_resource_link("handbook_link", "NHWA, Indicator, HandBook");
        get_resource_link("userguide_link", "NHWA, User, guide");
        get_resource_link("occupation_link", "NHWA, Occupation, Mapping");
    });
});
