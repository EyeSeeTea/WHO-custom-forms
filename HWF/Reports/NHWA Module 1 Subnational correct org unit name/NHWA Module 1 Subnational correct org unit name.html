<style type="text/css" media="screen">
    #content {
        padding: 20px;
    }

    #data table {
        border-collapse: collapse;
    }

    #data table,
    #data th,
    #data td {
        border: 1px solid #c0c0c0;
        border-spacing: 0px;
    }

    #data td,
    #data th {
        text-align: center;
        height: 30px;
        padding: 10px;
        margin: 10px;
        min-width: 150px;
    }

    #custom-form-loader {
        color: #1c425c;
        font-size: 14px;
        border: 1px solid #9aaab5;
        margin: 20px;
        text-align: center;
        display: none;
        border-radius: 3px;
    }
</style>
<script src="https://unpkg.com/mustache@4.0.1"></script>
<script id="template" type="x-tmpl-mustache">
    <h3> Module 1 (subnational) with fixes for organisation unit name</h3>
    <div id="data">
        <table>
            <thead>
                <tr>
                    <th>Organisation unit Id</th>
                    <th>Organisation unit name</th>
                    <th>Organisation unit name to fix</th>
                    <th></th>
                </tr>
            </thead>
            <tbody>
                {{#dataValues}}
                <tr>
                    <td>{{orgUnitId}}</td>
                    <td>{{currentName}}</td>
                    <td>{{correctName}}</td>
                    <td> <button onclick="saveValue('{{period}}','{{orgUnitId}}','{{dataElementId}}','{{categoryOptionComboId}}','{{currentName}}');">Dismiss</button></td>
                </tr>
                {{/dataValues}}
            </tbody>
        </table>
    </div>
</script>
<script type="text/javascript">
    var module1SubnationalId = "Humg4HbkmJg";

    function saveValue(period, orgUnit, dataElement, categoryOptionCombo, value) {
        document.getElementById("content").innerHTML = "";
        $("#custom-form-loader").show();

        const bodyData = {
            dataValues: [
                {
                    dataSet: module1SubnationalId,
                    period,
                    orgUnit,
                    dataElement,
                    categoryOptionCombo,
                    value
                }
            ]
        };

        $.ajax({
            url: "../api/dataValueSets",
            data: JSON.stringify(bodyData),
            type: "POST",
            dataType: "json",
            contentType: "application/json",
            success: response => {
                console.log({ response });

                loadData();
            },
            error: function (xhr) {
                console.log("Error in the request");
                console.log(xhr);
            },
        });
    }

    function loadData() {
        $("#custom-form-loader").show();

        debugger;

        $.ajax({
            url: "../api/sqlViews/buZ8poY0ZzX/data",
            success: response => {
                const dataValues = response.listGrid.rows
                    .map(row => {
                        return {
                            dataElementId: row[0],
                            orgUnitId: row[1],
                            currentName: row[2],
                            categoryOptionComboId: row[3],
                            period: row[4],
                            correctName: row[5],
                            parent: row[6],
                        }
                    });

                const data = {
                    orgUnitName: dhis2.report.organisationUnit.name,
                    period: "Esto???",
                    dataValues
                }

                var template = document.getElementById("template").innerHTML;
                const htmlFromTemplate = Mustache.render(template, data);

                $("#custom-form-loader").hide();
                document.getElementById("content").innerHTML = htmlFromTemplate;

            },
            error: function (xhr) {
                console.log("Error in the request");
                console.log(xhr);
            },
        });

    }

    jQuery(document).ready(function () {
        loadData();
    });
</script>

<div id="custom-form-loader">
    <img id="loader" src="../images/ajax-loader-circle.gif" />

    <p>Please wait while the system is loading the report...</p>
</div>
<div id="content">

</div>