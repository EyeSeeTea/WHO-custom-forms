<div>
<style type="text/css">#completeButton {
    display: none;
}

#newCompleteButton {
    display: inline-block !important;
}

.cde table {
    border-collapse: collapse;
}

button[disabled],
html input[disabled] {
    color: grey !important;
}

.cde table,
.cde th,
.cde td {
    border: 1px solid #c0c0c0;
}

.cde td,
.cde th {
    height: 30px;
    padding: 10px;
    margin: 10px;
    min-width: 150px;
}
.cde table thead th {
    text-align: center;
}
.cde-greyfield {
    background-color: #e0e0e0;
}

.selectBox {
    position: relative;
}

.selectBox select {
    width: 100%;
    font-weight: bold;
}

.overSelect {
    position: absolute;
    left: 0;
    right: 0;
    top: 0;
    bottom: 0;
}

.hwf {
    display: none;
    border: 1px #dadada solid;
    padding: 8px;
}

#label {
    display: block;
    text-align: left;
}

.check {
    display: block;
}

input[type="text"] {
    text-align: center;
    width: 80%;
}

textarea {
    width: 80%;
}

.td-input {
    text-align: center;
}

.numeric-de {
    text-align: center;
    white-space: pre;
}

.simple-de {
    text-align: center;
    white-space: pre;
}

.multiselect {
    width: 250px;
}

#custom-form-loader {
    color: #1c425c;
    font-size: 14px;
    margin: 20px;
    text-align: center;
    display: none;
    border-radius: 3px;
}

.cde table thead tr:nth-child(1) th {
    position: sticky;
    position: -webkit-sticky;
    top: 90px;
    background: #f5f5f5;
    z-index: 50;
}

.cde table thead tr:nth-child(2) th {
    position: sticky;
    position: -webkit-sticky;
    top: 141px;
    background: #f5f5f5;
    z-index: 50;
}

#leftBar {
    z-index: 100;
}

#Pagination {
    margin-top: 16px;
    font-size: 14px;
}

.pagination-next-orgUnitsTable:hover,
.pagination-pre-orgUnitsTable:hover {
    background: black;
    color: white;
    text-decoration: none;
}

.pagination-next-orgUnitsTable,
.pagination-pre-orgUnitsTable {
    box-sizing: border-box;
    display: inline-block;
    text-align: center;
    padding: 4px;
    text-decoration: none;
    cursor: pointer;
    color: #333;
    border: 1px solid transparent;
    border-radius: 2px;
    text-decoration: none;
}
.no-pag {
    cursor: default;
    color: #666 !important;
    border: 1px solid transparent;
    background: transparent;
    box-shadow: none;
    cursor: default;
}

.no-pag:hover {
    background: transparent;
}

.currentSelectionContainer {
    background: #fff;
    width: 100%;
    height: 42px;
    position: fixed;
    top: 48px;
    z-index: 10;
}
</style>
<script src="https://unpkg.com/mustache@4.0.1"></script><script id="orgUnitsTable_template" type="x-tmpl-mustache"><table><thead><tr><th>SN</th>
<th></th>
<th></th>
<th>1</th>
<th>1.1</th>
<th>1.2</th>
<th>1.3</th>
<th>2</th>
<th>2.1</th>
<th>2.2</th>
<th>2.3</th>
<th>3</th>
<th>3.1</th>
<th>3.2</th>
<th>3.3</th>
<th>4</th>
<th>5</th>
<th></th></tr>
<tr><th>Occupation</th>
<th class="simple-de">Subnational level name</th>
<th class="simple-de">Correct organisation unit name</th>
<th class="numeric-de">Medical Doctors</th>
<th class="numeric-de">General Medical Practitioners</th>
<th class="numeric-de">Specialist Medical Practitioners</th>
<th class="numeric-de">Medical doctors not further defined</th>
<th class="numeric-de">Nursing Personnel</th>
<th class="numeric-de">Nursing Professionals</th>
<th class="numeric-de">Nursing Associate Professionals</th>
<th class="numeric-de">Nurses not further defined</th>
<th class="numeric-de">Midwifery personnel</th>
<th class="numeric-de">Midwifery Professionals</th>
<th class="numeric-de">Midwifery Associate Professionals</th>
<th class="numeric-de">Midwives not further defined</th>
<th class="numeric-de">Dentists</th>
<th class="numeric-de">Pharmacists</th>
<th class="simple-de">If you have data on occupations and their source title, that are not listed above please provide below</th></tr></thead>
<tbody>{{#rows}}
<tr><th>Total</th>
<th class="simple-de">{{orgUnitName}}</th>
<td class="td-input"><input id="{{orgUnitId}}-ZUCnSGgjlrw-Xr12mI7VPn3-val" type="text"/></td>
<td class="td-input read-only"><input id="{{orgUnitId}}-qcDKkL7Xkl4-Xr12mI7VPn3-val" type="text"/></td>
<td class="td-input"><input id="{{orgUnitId}}-mHFT8rZ6ksz-Xr12mI7VPn3-val" type="text"/></td>
<td class="td-input"><input id="{{orgUnitId}}-qMdjQN91JDi-Xr12mI7VPn3-val" type="text"/></td>
<td class="td-input"><input id="{{orgUnitId}}-ePgUyGHxJuI-Xr12mI7VPn3-val" type="text"/></td>
<td class="td-input read-only"><input id="{{orgUnitId}}-ok6yvzSABcU-Xr12mI7VPn3-val" type="text"/></td>
<td class="td-input"><input id="{{orgUnitId}}-Rnuo4SphAdV-Xr12mI7VPn3-val" type="text"/></td>
<td class="td-input"><input id="{{orgUnitId}}-mHD3Efts57E-Xr12mI7VPn3-val" type="text"/></td>
<td class="td-input"><input id="{{orgUnitId}}-T58TEnz6WgZ-Xr12mI7VPn3-val" type="text"/></td>
<td class="td-input read-only"><input id="{{orgUnitId}}-bDQt7HaZCu9-Xr12mI7VPn3-val" type="text"/></td>
<td class="td-input"><input id="{{orgUnitId}}-EqDGfdOIX9a-Xr12mI7VPn3-val" type="text"/></td>
<td class="td-input"><input id="{{orgUnitId}}-rfqaKzMPEdf-Xr12mI7VPn3-val" type="text"/></td>
<td class="td-input"><input id="{{orgUnitId}}-QC2yRZy5Fn7-Xr12mI7VPn3-val" type="text"/></td>
<td class="td-input"><input id="{{orgUnitId}}-B6boWAxO6T4-Xr12mI7VPn3-val" type="text"/></td>
<td class="td-input"><input id="{{orgUnitId}}-lHfsZY4fyv4-Xr12mI7VPn3-val" type="text"/></td>
<td class="td-input"><textarea id="{{orgUnitId}}-kiwzlhjDZG9-Xr12mI7VPn3-val"></textarea></td></tr>
{{/rows}}</tbody></table></script><script>// **** sheetsee-tables ****
// https://github.com/jlord/sheetsee-tables/blob/master/index.js
// I have not found a cdn to download by scrript link
// I try https://cdn.rawgit.com/jlord/sheetsee.js/master/js/sheetsee.js but fail sometimes
var tblOpts = {};

// Only called the very first time
function makeTable(data) {
    tblOpts = data;
    tblOpts.sortMeta = {};
    tblOpts.pgnMta = {};

    if (!tblOpts.templateID) {
        tblOpts.templateID = tblOpts.tableDiv.replace("#", "") + "_template";
    }

    buildPaginationMeta(data.data, data.pagination);

    prepTable();
    initiateTableSorter();
}

// SORTING

// Called once to listen for clicks on table headers
function initiateTableSorter() {
    document.body.addEventListener("click", function(event) {
        if (event.target.classList.contains("tHeader")) {
            perpareSort(event);
        }
    });
}

// Prepare to be sorted
function perpareSort(event) {
    if (!tblOpts.sortMeta.sorted || tblOpts.sortMeta.sorted === "descending") {
        tblOpts.sortMeta.sorted = "ascending";
    } else if (tblOpts.sortMeta.sorted === "ascending") tblOpts.sortMeta.sorted = "descending";
    // TODO maybe make all keys in data lowercase...
    tblOpts.sortMeta.sortBy = event.target.innerHTML.replace(/\s/g, "").replace(/\W/g, "");
    tblOpts.tableDiv = "#" + event.target.closest("div").getAttribute("id");
    sortData();
}

// Sort the data
function sortData() {
    var sortGroup;
    if (tblOpts.filtering) sortGroup = tblOpts.pgnMta.allRows;
    else sortGroup = tblOpts.data;

    sortGroup.sort(function(a, b) {
        var aa = a[tblOpts.sortMeta.sortBy].toLowerCase();
        var bb = b[tblOpts.sortMeta.sortBy].toLowerCase();
        aa = aa.match(/^[\d,]$/) ? Number(aa) : aa;
        bb = bb.match(/^[\d,]$/) ? Number(bb) : bb;

        if (aa < bb) return -1;
        if (aa > bb) return 1;
        return 0;
    });
    if (tblOpts.sortMeta.sorted === "descending") sortGroup.reverse();
    // This table update doesn't change pagination; reset direction
    if (tblOpts.pgnMta.dir) tblOpts.pgnMta.dir = Number(0);
    // If the table has been filtered, just sort those
    if (tblOpts.filtering) prepTable(tblOpts.pgnMta.allRows);
    else prepTable();
}

// FITERING

// Set up listeners for clear and input
function initiateTableFilter(options) {
    // If things are missing, return
    if (document.querySelector(".clear") === null) return;
    if (!options.filterDiv) return;
    if (document.getElementById(options.filterDiv.replace("#", "")) === null) return;

    tblOpts.filtering = true;
    var filterInput = document.getElementById(options.filterDiv.replace("#", ""));

    // listen for clicks on clear button
    document.querySelector(".clear").addEventListener("click", function() {
        filterInput.value = "";
        // This resets the table to initial direction
        if (tblOpts.pgnMta.dir) tblOpts.pgnMta.dir = Number(0);
        // TODO should it reset to page 1
        prepTable();
    });
    // Listen for input in the serach field
    filterInput.addEventListener("keyup", function(e) {
        searchTable(e.target.value);
    });
}

// Search the table with input
function searchTable(searchTerm) {
    var filteredList = [];
    tblOpts.data.forEach(function(object) {
        var stringObject = JSON.stringify(object).toLowerCase();
        if (stringObject.match(searchTerm.toLowerCase())) filteredList.push(object);
    });
    // Clear direction and page
    if (tblOpts.pgnMta.dir) tblOpts.pgnMta.dir = Number(0);
    if (tblOpts.pgnMta.crntPage) tblOpts.pgnMta.crntPage = Number(1);
    prepTable(filteredList);
}

// TABLE MAKING

// Prep the data and pagination for the table
function originalPrepTable(filteredList) {
    var data = filteredList || tblOpts.data;

    // If they don't specifiy pagination, draw table with everything
    if (!tblOpts.pagination) return updateTable(data);

    // Create Pagination Metadata
    buildPaginationMeta(data);
    // Build the table with paginated data
    updateTable(tblOpts.pgnMta.crntRows);
    // Append pagination DOM elements
    // If there is no data, don't paginate
    if (data.length === 0) addPaginationDOM(true);
    else addPaginationDOM();
}

function prepTable(filteredList) {
    //Eyeseetea prepTable wrapper

    if (tblOpts.onLoadingPage) {
        var dir = tblOpts.pgnMta.dir || 0;
        var currentPage = tblOpts.pgnMta.crntPage || 1;
        var loadingPage = currentPage + dir;
        onLoadingPage(loadingPage).then(data => {
            tblOpts.data = data;

            var data = filteredList || tblOpts.data;

            // If they don't specifiy pagination, draw table with everything
            if (!tblOpts.pagination) return updateTable(data);

            // Create Pagination Metadata
            buildPaginationMeta(data);
            // Build the table with paginated data
            updateTable(tblOpts.pgnMta.crntRows);

            if (tblOpts.onLoadedPage) tblOpts.onLoadedPage();

            // Append pagination DOM elements
            // If there is no data, don't paginate
            if (data.length === 0) addPaginationDOM(true);
            else addPaginationDOM();
        });
    } else {
        originalPrepTable(filteredList);
        if (tblOpts.onLoadedPage) tblOpts.onLoadedPage();
    }
}

function updateTable(data) {
    var rawTemplate = document.getElementById(tblOpts.templateID).innerHTML;
    var content = Mustache.render(rawTemplate, { rows: data });
    document.getElementById(tblOpts.tableDiv.replace("#", "")).innerHTML = content;
}

// PAGINATION

// Create the metadata used in pagination
function buildPaginationMeta(data) {
    var dir = tblOpts.pgnMta.dir || 0;
    var current = tblOpts.pgnMta.crntPage || 1;
    tblOpts.pgnMta.allRows = data;
    tblOpts.pgnMta.allRowsLen = data.length;
    tblOpts.pgnMta.totalPages = Math.ceil(tblOpts.pgnMta.allRowsLen / tblOpts.pagination);
    tblOpts.pgnMta.crntPage = current + dir;
    tblOpts.pgnMta.nextPage = tblOpts.pgnMta.crntPage - 1;
    tblOpts.pgnMta.crntStart = tblOpts.pgnMta.crntPage * tblOpts.pagination - tblOpts.pagination;
    tblOpts.pgnMta.crntEnd = tblOpts.pgnMta.crntPage * tblOpts.pagination;
    tblOpts.pgnMta.crntRows = data.slice(tblOpts.pgnMta.crntStart, tblOpts.pgnMta.crntEnd);
    return;
}

// Add pagination elements and listeners to the DOM
function addPaginationDOM(nopages) {
    var tblId = tblOpts.tableDiv.slice(1);
    var el = document.createElement("div");
    el.setAttribute("id", "Pagination");
    el.setAttribute("pageno", tblOpts.pgnMta.crntPage);
    el.classList.add("table-pagination");
    if (nopages) {
        el.innerHTML = "No results</div>";
    } else if (tblOpts.pgnMta.allRowsLen <= tblOpts.pagination) {
        el.innerHTML = "Page 1 of 1</div>";
    } else {
        el.innerHTML =
            "Showing page " +
            tblOpts.pgnMta.crntPage +
            " of " +
            tblOpts.pgnMta.totalPages +
            " <a class='pagination-pre-" +
            tblId +
            "'>Previous</a>" +
            " <a class='pagination-next-" +
            tblId +
            "'>Next</a></div>";
    }
    document.getElementById(tblId).append(el);
    // Don't show pagination in these cases TODO clean up
    if (nopages) return;
    if (tblOpts.pgnMta.allRowsLen <= tblOpts.pagination) return;

    // On the last page
    if (tblOpts.pgnMta.crntPage >= tblOpts.pgnMta.totalPages) {
        document.querySelector(".pagination-next-" + tblId).classList.add("no-pag");
        document.querySelector(".pagination-pre-" + tblId).classList.remove("no-pag");
    }
    // On the first page
    if (tblOpts.pgnMta.crntPage === 1) {
        document.querySelector(".pagination-pre-" + tblId).classList.add("no-pag");
        document.querySelector(".pagination-next-" + tblId).classList.remove("no-pag");
    }
    // Listen for next clicks
    document.querySelector(".pagination-next-" + tblId).addEventListener("click", function(e) {
        if (e.target.classList.contains("no-pag")) return;
        tblOpts.pgnMta.dir = Number(1);
        // if there is text in the search and you are paginating
        // through filtered data, build table with what is in paginationmeta data
        if (tblOpts.filtering) prepTable(tblOpts.pgnMta.allRows);
        else prepTable();
    });
    // Listen for previous clicks
    document.querySelector(".pagination-pre-" + tblId).addEventListener("click", function(e) {
        if (e.target.classList.contains("no-pag")) return;
        tblOpts.pgnMta.dir = Number(-1);
        // if there is text in the search and you are paginating
        // through filtered data, build table with what is in paginationmeta data
        if (tblOpts.filtering) prepTable(tblOpts.pgnMta.allRows);
        else prepTable();
    });
}
</script><script>var module1SubnationalId = "Humg4HbkmJg";

var calculatedNumericCells = [
    //Working Details

    //1 - Medical Doctors
    {
        id: "qcDKkL7Xkl4-Xr12mI7VPn3-val",
        children: [
            "mHFT8rZ6ksz-Xr12mI7VPn3-val",
            "qMdjQN91JDi-Xr12mI7VPn3-val",
            "ePgUyGHxJuI-Xr12mI7VPn3-val",
        ],
    },
    //2 - Nursing Personnel
    {
        id: "ok6yvzSABcU-Xr12mI7VPn3-val",
        children: [
            "Rnuo4SphAdV-Xr12mI7VPn3-val",
            "mHD3Efts57E-Xr12mI7VPn3-val",
            "T58TEnz6WgZ-Xr12mI7VPn3-val",
        ],
    },
    //3 - Midwifery personnel
    {
        id: "bDQt7HaZCu9-Xr12mI7VPn3-val",
        children: [
            "EqDGfdOIX9a-Xr12mI7VPn3-val",
            "rfqaKzMPEdf-Xr12mI7VPn3-val",
            "QC2yRZy5Fn7-Xr12mI7VPn3-val",
        ],
    },
];

function calculateNumericCell(inputId) {
    const items = inputId.split("-");
    items.shift();
    const noOrgUnitId = items.join("-");
    const organisationUnitId = inputId.split("-")[0];
    var total = 0;

    var calculateNumericCell = calculatedNumericCells.find(cell => {
        return cell.id == noOrgUnitId;
    });

    calculateNumericCell.children.forEach(childId => {
        const ouChildId = organisationUnitId + "-" + childId;

        var value = $("#" + ouChildId).val();

        if (value != "" && !isNaN(value)) {
            total = total + parseInt(value);
        }
    });

    $("#" + inputId).val(total);
    $("#" + inputId).trigger("change");
}

function onInputChange(id) {
    const organisationUnitId = id.split("-")[0];
    const dataElementId = id.split("-")[1];
    const optionComboId = id.split("-")[2];

    saveVal(dataElementId, optionComboId, id);

    calculatedNumericCells.forEach(calculatedNumericCell => {
        calculatedNumericCell.children.forEach(function(childId) {
            if (id === organisationUnitId + "-" + childId) {
                calculateNumericCell(organisationUnitId + "-" + calculatedNumericCell.id);
                return;
            }
        });
    });
}

function get_resource_link(element_id, tokens) {
    $.ajax({
        url: "../api/documents",
        type: "get",
        data: {
            fields: "id",
            filter: "name:token:" + tokens,
        },
        success: function(response) {
            id = response["documents"][0]["id"];
            document.getElementById(element_id).href = "../api/documents/" + id + "/data";
        },
        error: function(xhr) {
            console.log("Error in the request");
            console.log(xhr);
        },
    });
}

function showCheckboxes(element) {
    var checkboxes = document.getElementById(element);

    if (checkboxes.style.display === "none") {
        checkboxes.style.display = "block";
        expanded = true;
    } else {
        checkboxes.style.display = "none";
        expanded = false;
    }
}

function loadValues() {
    $(".read-only input").each(function() {
        $(this).attr("disabled", "disabled");
    });

    const $nextPageButton = document.querySelector(".pagination-next-orgUnitsTable");

    if ($nextPageButton) {
        $nextPageButton.addEventListener("click", function(e) {
            if (e.target.classList.contains("no-pag")) return;

            loadValues();
        });
    }

    const $previousPageButton = document.querySelector(".pagination-pre-orgUnitsTable");

    if ($previousPageButton) {
        $previousPageButton.addEventListener("click", function(e) {
            if (e.target.classList.contains("no-pag")) return;

            loadValues();
        });
    }

    var periodId = $("#selectedPeriodId").val();

    var params = {
        period: periodId,
        dataSet: module1SubnationalId,
        orgUnit: dhis2.de.getCurrentOrganisationUnit(),
        children: true,
    };

    $.ajax({
        url: "../api/dataValueSets",
        data: params,
        dataType: "json",
        success: json => {
            $.safeEach(json.dataValues, function(i, dataValue) {
                var fieldId = `#${dataValue.orgUnit}-${dataValue.dataElement}-${dataValue.categoryOptionCombo}-val`;
                if ($(fieldId).length > 0) {
                    var entryField = $(fieldId);
                    if ("true" == dataValue.value && entryField.attr("type") == "checkbox") {
                        $(fieldId).prop("checked", true);
                    } else {
                        $(fieldId).val(dataValue.value);
                    }
                }
            });

            $("input[type=text]").on("change", function(e) {
                onInputChange(e.target.id);
            });
            $("textarea").on("change", function(e) {
                onInputChange(e.target.id);
            });
        },
        error: function(xhr) {
            console.log("Error in the request");
            console.log(xhr);
        },
    });
}

function renderCustomForm() {
    $(".cde table tbody").empty();
    $("#custom-form-loader").show();

    const filter = `paging=false&var=dataSet:${module1SubnationalId}&var=orgUnit:${dhis2.de.currentOrganisationUnitId}`;

    $.ajax({
        url: `../api/sqlViews/F9WNm3XNjli/data?${filter}`,
        type: "get",
        success: function(response) {
            const orgUnits = response.listGrid.rows.map(row => ({
                orgUnitId: row[0],
                orgUnitName: row[1],
            }));

            var tableOptions = {
                data: orgUnits,
                pagination: 10,
                tableDiv: "#orgUnitsTable",
                templateID: "orgUnitsTable_template",
            };

            makeTable(tableOptions);

            $("#custom-form-loader").hide();

            loadValues();
        },
        error: function(xhr) {
            console.log("Error in the request");
            console.log(xhr);
        },
    });
}

$(document).ready(function() {
    $(function() {
        $("#mod2_tabs").tabs();

        dhis2.util.on("dhis2.de.event.dataValuesLoaded", function(event, ds) {
            renderCustomForm();
        });
    });
    $(function() {
        console.log("Updating file resources links");
        get_resource_link("handbook_link", "NHWA, Indicator, HandBook");
        get_resource_link("userguide_link", "NHWA, User, guide");
        get_resource_link("occupation_link", "NHWA, Occupation, Mapping");
    });

    if($("#currentSelection").length > 0) {
        $("#currentSelection").wrap("<div class=\"currentSelectionContainer\"></div>");
    }
});
</script>
<h3 style="text-align: center;"><strong>Active Health Workforce Demographic Details</strong></h3>

<h4 style="text-align: right; font-family: times;"><a href="../api/documents/p6IINqTYv2f/data" id="handbook_link" target="_blank">Access the NHWA HANDBOOK</a></h4>

<h4 style="text-align: right; font-family: times;"><a href="../api/documents/OCoAAGYwapP/data" id="userguide_link" target="_blank">Access the NHWA USER GUIDE</a></h4>

<h4 style="text-align: right; font-family: times;"><a href="../api/documents/KC4DKufIIVw/data" id="occupation_link" target="_blank">Access the NHWA OCCUPATION MAPPING</a></h4>

<div id="mod2_tabs">
<ul>
	<li><a href="#tab0">Working Details</a></li>
</ul>

<div id="tab0">
<h2>SECTION 1: HWF WORKING DETAILS</h2>

<div class="cde" id="orgUnitsTable">&nbsp;</div>

<div id="custom-form-loader"><img id="loader" src="../images/ajax-loader-circle.gif" />
<p>Please wait while the system is loading the custom form...</p>
</div>
</div>
</div>
</div>
